**Package 04: Market Prices + FX + Views**

**Goal:** Upload price and FX data, compute derived values with full currency attribution, serve Roll Forward / Performance / Holdings from one endpoint.

---

**Business Context: Three Views, One Endpoint**

CIOs look at portfolios three ways. Same data, different lens:

| View | Question it answers | Key columns |
|------|---------------------|-------------|
| **Roll Forward** | "Where did my returns come from?" | OB → Flows → FX Impact → Asset P&L → CB |
| **Performance** | "What's doing well vs. poorly?" | NAV End, TWR, IRR, PnL, Confidence |
| **Holdings** | "What do I own right now?" | Assets grouped by custodian or legal entity, with weights |

Frontend renders these as tabs, grouping/sorting the same response differently. No tab-specific endpoints.

---

**Schema**

```
market_prices: id, symbol, date, price, source (manual/csv_import), 
               created_at, unique(symbol, date)

fx_rates: id, date, from_ccy, to_ccy, rate, source (ecb/manual),
          created_at, unique(date, from_ccy, to_ccy)
```

Both tables are system-level (no tenant_id, no RLS).

---

**Endpoints**

```
POST /market-prices/import    — bulk CSV (symbol, date, price)
POST /market-prices/fetch     — fetch prices for tickers + date range (Polygon or EODHD)
POST /fx-rates/import         — bulk CSV (date, from_ccy, to_ccy, rate)
GET  /views/portfolio         — single endpoint, all three views
GET  /assets/{id}/history     — value time series for chart
```

`/market-prices/fetch` — endpoint signature stable, provider swappable. Initial implementation targets Polygon or EODHD.

---

**FX Rate Requirements**

The system needs FX rates for multiple dates to support attribution:

| Date needed | Purpose |
|-------------|---------|
| Period start | Convert opening balances |
| Each flow date | Convert flows at actual rate |
| Period end | Convert closing balances, calculate FX impact |

`/fx-rates/import` should accept date ranges. Missing any required rate → 400 error listing missing date/pair combinations.

---

**Portfolio Endpoint**

**Params:**
```
?start=2024-01-01&end=2024-03-31&family=uuid&legal_entity=string&collection=uuid,uuid
```

Multiple collections use OR logic (asset in any listed collection passes filter).

**Response shape (per-asset rows):**
```json
{
  "base_currency": "USD",
  "assets": [
    {
      "id": "uuid",
      "name": "AAPL",
      "category": "public_equity",
      "legal_entity": "Family Trust",
      "custodian": "Schwab",
      "currency": "USD",
      "current_quantity": 100,
      
      "start_value": 15000,
      "end_value": 17500,
      "start_value_base": 15000,
      "end_value_base": 17500,
      
      "net_flows": 0,
      "net_flows_base": 0,
      
      "fx_impact_position": 0,
      "fx_impact_flows": 0,
      "asset_pnl_base": 2500,
      "pnl_base": 2500,
      
      "weight_pct": 12.5,
      "simple_return_pct": 16.67,
      "twr_pct": 16.67,
      "irr_pct": 16.67,
      "irr_status": "converged",
      "twr_quality": "exact",
      
      "price_source": "market",
      "last_valued_at": "2024-03-31",
      "staleness_days": 0,
      "valuation_confidence": "fresh",
      "inception_date": "2023-06-15",
      "in_period": true
    }
  ],
  "totals": {
    "start_value_base": 1000000,
    "end_value_base": 1050000,
    "net_flows_base": 25000,
    "fx_impact_position": 5000,
    "fx_impact_flows": 200,
    "asset_pnl_base": 19800,
    "pnl_base": 25000,
    "twr_pct": 2.48,
    "assets_excluded": 2,
    "fresh_weight_pct": 65.0,
    "aging_weight_pct": 20.0,
    "stale_weight_pct": 15.0
  }
}
```

**Roll Forward reconciliation (must balance):**
```
start_value_base 
+ net_flows_base 
+ fx_impact_position 
+ fx_impact_flows 
+ asset_pnl_base 
= end_value_base
```

This is the entire point of Roll Forward. If it doesn't reconcile, something is wrong.

---

**Asset History Endpoint**

**Params:**
```
?start=2024-01-01&end=2024-12-31
```

**Response:**
```json
{ "points": [{ "date": "2024-01-31", "value": 7500000 }, ...] }
```

**Source by category:**
- `public_equity`: market_price × quantity at each date
- All others: valuation entries only

No interpolation—return only dates with actual data.

---

**Calculation Rules**

**Current value:**
- Public equity: current_quantity × latest market_price for ticker
- Everything else: latest entry.value by entry_date
- Public equity with no market_price: fallback to latest valuation entry, set `price_source: "valuation"`

**Currency conversion & FX attribution:**

For each asset in a foreign currency:

| Field | Calculation |
|-------|-------------|
| `start_value_base` | start_value × FX rate at period start |
| `end_value_base` | end_value × FX rate at period end |
| `net_flows_base` | sum of (each flow × FX rate at flow date) |
| `fx_impact_position` | start_value × (end_rate − start_rate) |
| `fx_impact_flows` | sum of (each flow × (end_rate − flow_date_rate)) |
| `asset_pnl_base` | (end_value − start_value − net_flows) × end_rate |
| `pnl_base` | fx_impact_position + fx_impact_flows + asset_pnl_base |

For assets in base currency: all `fx_impact_*` fields = 0.

**Period calculations:**
- **start_value:** latest entry per asset where entry_date < period_start
- **end_value:** latest entry per asset where entry_date ≤ period_end
- **net_flows:** sum of cash_flow entries within period
- **weight_pct:** asset's end_value_base ÷ portfolio end_value_base × 100
- **simple_return_pct:** pnl ÷ start_value (null if start_value is null or zero)

**TWR (Modified Dietz):**
```
twr_pct = (end_value - start_value - net_flows) / (start_value + Σ(flow × weight))
where weight = (period_days - days_since_start) / period_days
```
Use this formula exactly. Portfolio-level TWR applies Modified Dietz to aggregated totals, not weighted average of asset TWRs (the latter is mathematically incorrect).

- `twr_quality`: `"exact"` if valuations exist at period start AND end; `"estimated"` if either is interpolated

**IRR:**
Cash flow series: [-start_value at day 0, flows at their dates, +end_value at period end]
- Annualize for periods ≥ 1 year
- Do NOT annualize for periods < 1 year (CIOs want "Q1 was 4%" not "Q1 was 17% annualized")
- Cap iterations at 100; if non-convergence: `irr_pct: null`, `irr_status: "did_not_converge"`
- On success: `irr_status: "converged"`

**Staleness & confidence:**
- `staleness_days`: days since last valuation (from period end date)
- `valuation_confidence`:
  - `"fresh"`: staleness_days < 30
  - `"aging"`: 30 ≤ staleness_days < 90
  - `"stale"`: staleness_days ≥ 90

**Totals handling:**
- Exclude assets with `in_period: false` from totals (acquired mid-period)
- `assets_excluded`: count of excluded assets
- `fresh_weight_pct`: % of end_value_base from assets with confidence = "fresh"
- `aging_weight_pct`: % of end_value_base from assets with confidence = "aging"  
- `stale_weight_pct`: % of end_value_base from assets with confidence = "stale"
- Portfolio `twr_pct`: Modified Dietz on aggregated totals

Rationale for exclusion: CIOs ask "how did my portfolio perform this quarter" — assets that didn't exist for the full period distort that answer.

Rationale for confidence weights: CIO needs instant read on data quality. "Portfolio return: 7.2% (35% stale)" tells them whether to trust the number.

---

**Edge Cases**

| Scenario | Behavior |
|----------|----------|
| Asset acquired mid-period | `start_value = null`, `in_period = false`, excluded from totals, still in response |
| Asset disposed mid-period | Included, end_value from last entry before disposal |
| Zero start_value | `simple_return_pct = null`, `twr_pct = null`, pnl still calculated |
| No market_price for public equity | Use latest valuation entry, `price_source: "valuation"` |
| No mid-period flows | `twr_pct` equals `simple_return_pct`, `fx_impact_flows = 0` |
| Missing FX rate for any required date | 400 error listing all missing date/pair combinations |
| IRR doesn't converge | `irr_pct: null`, `irr_status: "did_not_converge"` |

---

**Acceptance Criteria**

*Market prices:*
1. Upload prices CSV → market_prices rows created
2. Duplicate symbol+date in upload → upsert (update price if exists)
3. Public equity with no market_price → uses last valuation entry as fallback

*FX rates:*
4. Upload FX rates CSV → fx_rates rows created
5. System accepts rates for arbitrary dates (not just period boundaries)
6. Missing FX rate for required date → 400 with specific error listing missing date/pair

*Portfolio endpoint:*
7. No filters → all active assets for tenant
8. Date range → start/end values computed correctly
9. Cash_flow in period → reflected in net_flows, not asset_pnl
10. Asset acquired mid-period → start_value null, in_period false, excluded from totals
11. Asset with zero start_value → return percentages null, no error
12. weight_pct sums to 100 across all assets with end_value

*FX attribution:*
13. Foreign currency asset → fx_impact_position reflects rate movement on opening balance
14. Foreign currency flow → fx_impact_flows reflects rate movement from flow date to period end
15. Roll Forward reconciles: start + flows + fx_position + fx_flows + asset_pnl = end
16. Base currency assets → all fx_impact fields = 0

*TWR & IRR:*
17. No mid-period flows → twr_pct equals simple_return_pct
18. Mid-period flow → twr_pct uses Modified Dietz with day-weighted flows
19. Portfolio twr_pct uses aggregated totals, not weighted average of asset TWRs
20. twr_quality = "exact" when start and end valuations exist
21. IRR non-convergence → null with status flag, response still valid
22. Periods < 1 year → IRR not annualized

*Staleness & confidence:*
23. staleness_days calculated from period end, not current date
24. valuation_confidence assigned correctly per thresholds
25. Totals include fresh/aging/stale_weight_pct summing to 100%

*Asset history:*
26. Returns sparse data (only actual valuation dates)
27. Public equity history uses market_price × quantity, not valuation entries

---

**Gotchas**

- Compute on read, no caching — 100 assets is fast enough
- For public equities: value on cash_flow entries is cost basis, don't use for current value
- market_prices and fx_rates are system-level (no tenant_id, no RLS)
- FX rates needed for: period start, period end, AND every flow date in between
- Portfolio TWR ≠ weighted average of asset TWRs (common mistake)
- staleness_days is from period end, not from today (historical queries need historical staleness)
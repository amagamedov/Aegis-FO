**Package 03: Excel Import (Onboarding)**

**Goal:** Import current portfolio state, optionally layer in historical transactions and valuations. One wizard, three Excel files.

**Core principle:** Holdings are the anchor of truth (verifiable against brokerage statements). Transactions and valuations are optional history. Opening balance absorbs any gap—no forced reconciliation.

**Mental model for opening balance:** Think of it as "everything we can't explain with transaction history." Full history → opening balance is zero. No history → opening balance equals current holdings.

---

**Three-step flow:**

1. **Holdings (required)** → creates assets + opening balance entries
2. **Transactions (optional)** → historical cash_flow entries predating holdings
3. **Valuations (optional)** → historical marks for private assets

Holdings must be confirmed before transactions or valuations can be validated.

---

**Endpoints:**

```
POST /import/validate/holdings      — parse + validate, return row-by-row status
POST /import/confirm/holdings       — write assets + opening balance entries

POST /import/validate/transactions  — parse + validate against committed assets
POST /import/confirm/transactions   — write cash_flow entries

POST /import/validate/valuations    — parse + validate against committed assets
POST /import/confirm/valuations     — write valuation entries
```

---

**Holdings Excel**

| Column | Required | Notes |
|--------|----------|-------|
| name | Yes | Unique within tenant, join key for transactions/valuations |
| ticker | No | For public equities |
| category | Yes | `public_equity`, `private_fund`, `hedge_fund`, `real_estate`, `cash`, `other` |
| legal_entity | Yes | Which entity owns it |
| custodian | No | Where it's held |
| currency | No | Default USD |
| quantity | Conditional | Required for `public_equity`. Optional for funds. Null for `cash`, `real_estate`. |
| value | Yes | Current value in asset currency |
| as_of_date | Yes | Valuation date |

**Creates:** Asset record + opening balance entry (`entry_type=cash_flow`, `source=excel_import`, `notes="Opening balance"`)

---

**Transactions Excel**

| Column | Required | Notes |
|--------|----------|-------|
| asset_name | Yes | Must match name from holdings |
| date | Yes | Must be before asset's as_of_date |
| type | Yes | `buy`, `sell`, `contribution`, `distribution`, `dividend` |
| quantity | Conditional | Required for buy/sell |
| value | Yes | Absolute value, sign determined by type |
| cash_account | Conditional | Required for buy/sell/dividend |
| source_asset | Conditional | Required for dividend |
| notes | No | |

**Type behavior:**

| Type | Creates |
|------|---------|
| buy | Two entries: asset (+qty, +value), cash (−value). Linked by transaction_id. |
| sell | Two entries: asset (−qty, −value), cash (+value). Linked by transaction_id. |
| contribution | One entry: cash account +value |
| distribution | One entry: cash account −value |
| dividend | One entry: cash account +value, source_asset_id set |

**Opening balance adjustment:** When transactions exist, `adjusted_opening_qty = holdings_qty − SUM(transaction_qty)`. Surface in validation response so user understands what will be created.

---

**Valuations Excel**

| Column | Required | Notes |
|--------|----------|-------|
| asset_name | Yes | Must match name from holdings |
| date | Yes | |
| value | Yes | Total value in asset currency |

**Creates:** `entry_type=valuation` entries. Use for historical private fund NAVs, real estate appraisals, etc. Public equity prices come from provider (Package 04).

---

**Validation response shape:**

```json
{
  "valid": false,
  "summary": { "total_rows": 5, "valid_rows": 4, "error_rows": 1 },
  "rows": [
    {"row": 1, "status": "ok", "errors": [], "warnings": []},
    {"row": 2, "status": "error", "errors": ["Invalid category: 'privte_fund'"], "warnings": []}
  ]
}
```

---

**Validation rules:**

**Errors (block import):**
- Missing required column
- Invalid enum value
- Malformed date
- Quantity null for public_equity in holdings
- Transaction date ≥ asset's as_of_date
- asset_name not found — include fuzzy suggestions ("Did you mean 'Apple Inc'?")
- cash_account not found or not category=cash
- source_asset not found (for dividends)
- Formula in cell (starts with `=`)
- File >5MB or >10,000 rows

**Warnings (allow import):**
- Future dates
- Duplicate asset names
- Value > $1B

---

**Acceptance criteria:**

1. Valid holdings → assets + opening balance entries created
2. Invalid holdings → 400 with row-by-row errors, nothing written
3. Transactions with unknown asset_name → error with fuzzy suggestions
4. Transaction type=buy → two entries, shared transaction_id, opposite signs
5. Opening balance adjusted when transactions exist for same asset
6. Valuations → `entry_type=valuation` entries created
7. Each confirm wraps all writes in single DB transaction

---

**Gotchas:**

- `name` is join key during import only; post-import uses asset IDs
- Use `openpyxl` for Excel parsing
- Provide downloadable templates with dropdowns for enums